<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ä¿³å¥SQLãƒ‡ãƒ¢ï¼ˆSQLite / sql.jsï¼‰</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif; max-width: 1040px; margin: 2rem auto; padding: 0 1rem; }
    header { display: flex; align-items: baseline; gap: .75rem; margin-bottom: 1rem; }
    h1 { font-size: 1.4rem; margin: 0; }
    small { opacity: .75; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    textarea { width: 100%; min-height: 240px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 14px; padding: .75rem; border-radius: .5rem; }
    .btns { display: flex; flex-wrap: wrap; gap: .5rem; margin: .75rem 0 1rem; }
    button { cursor: pointer; padding: .7rem 1rem; border-radius: .7rem; border: 1px solid #1e40af; background: #2563eb; color: #fff; font-weight: 600; letter-spacing: .02em; box-shadow: 0 1px 2px #0003; }
    button:hover { filter: brightness(1.05); }
    button:disabled { background: #9ca3af; border-color: #9ca3af; color: #1f2937; cursor: not-allowed; }
    .card { border: 1px solid #8884; border-radius: .7rem; padding: .8rem; }
    table { border-collapse: collapse; width: 100%; font-size: 14px; }
    th, td { border: 1px solid #8884; padding: .45rem .5rem; text-align: left; }
    th { background: #00000010; }
    .muted { opacity: .7; font-size: .9em; }
    .right { text-align: right; }
    code { background: #00000010; padding: .15rem .35rem; border-radius: .4rem; }
    footer { margin-top: 2rem; opacity: .8; font-size: .9em; }
    input, select { background: inherit; color: inherit; }
  </style>
  <!-- sql.jsï¼ˆWASMï¼‰ã‚’CDNã‹ã‚‰èª­ã¿è¾¼ã¿ã€‚å¿…ãšè‡ªå‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚ˆã‚Šå…ˆã«ç½®ã -->
  <script src="https://cdn.jsdelivr.net/npm/sql.js@1.10.2/dist/sql-wasm.js"></script>
</head>
<body>
  <header>
    <h1>ä¿³å¥SQLãƒ‡ãƒ¢ï¼ˆSQLite / sql.jsï¼‰</h1>
    <small>1ãƒ•ã‚¡ã‚¤ãƒ« | ã‚µãƒ¼ãƒä¸è¦ | ç„¡æ–™ | å­¦ç¿’ç”¨</small>
  </header>

  <div class="row">
    <section class="card">
      <h2 style="margin-top:0">1) ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œ</h2>
      <p class="muted">ä¸‹ã®SQLã‚’æ›¸ãæ›ãˆã¦ <strong>å®Ÿè¡Œ</strong> ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚<br>ä¾‹ï¼š<code>SELECT h.text, a.name, k.term, s.name FROM haiku h LEFT JOIN authors a ON h.author_id=a.id LEFT JOIN kigo k ON h.kigo_id=k.id LEFT JOIN seasons s ON k.season_id=s.id;</code></p>
      <textarea id="sqlInput"></textarea>

      <div class="btns">
        <button id="runBtn">â–¶ å®Ÿè¡Œï¼ˆCtrl/âŒ˜+Enterï¼‰</button>
        <button data-snippet="SELECT * FROM haiku;">haiku å…¨ä»¶</button>
        <button data-snippet="SELECT * FROM kigo;">kigo å…¨ä»¶</button>
        <button data-snippet="SELECT h.id, h.text AS haiku, a.name AS author, k.term AS kigo, s.name AS season\nFROM haiku h\nLEFT JOIN authors a ON h.author_id=a.id\nLEFT JOIN kigo k ON h.kigo_id=k.id\nLEFT JOIN seasons s ON k.season_id=s.id\nORDER BY h.id;">JOIN ã‚µãƒ³ãƒ—ãƒ«ï¼ˆä¿³å¥Ã—å­£èªÃ—å­£ç¯€ï¼‰</button>
        <button data-snippet="SELECT s.name AS season, COUNT(*) AS haiku_count\nFROM haiku h\nLEFT JOIN kigo k ON h.kigo_id = k.id\nLEFT JOIN seasons s ON k.season_id = s.id\nGROUP BY s.name\nORDER BY haiku_count DESC;">é›†è¨ˆã‚µãƒ³ãƒ—ãƒ«ï¼ˆå­£ç¯€ã”ã¨ã®å¥æ•°ï¼‰</button>
        <button id="resetBtn" title="åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’å…¥ã‚Œç›´ã—ã¾ã™">ğŸ—˜ DBãƒªã‚»ãƒƒãƒˆ</button>
      </div>

      <!-- ã‹ã‚“ãŸã‚“æ¤œç´¢UI -->
      <div class="card" style="margin-top:.75rem">
        <div style="display:flex; gap:.5rem; flex-wrap:wrap; align-items:center">
          <strong>ã‹ã‚“ãŸã‚“æ¤œç´¢ï¼š</strong>
          <input id="qInput" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆä¾‹ï¼šè›™ / å¤è‰ / èŠ­è•‰ / å¤ï¼‰" style="flex:1; min-width:220px; padding:.6rem .7rem; border-radius:.6rem; border:1px solid #8884;">
          <select id="qType" style="padding:.6rem .7rem; border-radius:.6rem; border:1px solid #8884;">
            <option value="text">å¥ã®æœ¬æ–‡</option>
            <option value="author">ä½œè€…å</option>
            <option value="kigo">å­£èª</option>
            <option value="season">å­£ç¯€</option>
          </select>
          <button id="qRun">æ¤œç´¢</button>
        </div>
        <div style="margin-top:.5rem; display:flex; gap:.5rem; flex-wrap:wrap">
          <button class="chip" data-q="è›™" data-type="text">ğŸ¸ è›™ã‚’å«ã‚€å¥</button>
          <button class="chip" data-q="èŠ­è•‰" data-type="author">ğŸ‘¤ èŠ­è•‰ã®å¥</button>
          <button class="chip" data-q="å¤è‰" data-type="text">â˜˜ï¸ å¤è‰</button>
          <button class="chip" data-q="å¤" data-type="season">ğŸŒ å¤ã®å¥</button>
        </div>
      </div>

      <p id="status" class="muted">DBåˆæœŸåŒ–å¾…ã¡â€¦</p>
    </section>

    <section class="card">
      <h2 style="margin-top:0">2) çµæœ</h2>
      <div id="result"></div>
      <p class="muted">è¤‡æ•°ã® <code>SELECT</code> ã‚’æ›¸ã„ãŸå ´åˆã€é †ã«ã™ã¹ã¦è¡¨ç¤ºã—ã¾ã™ã€‚</p>
    </section>
  </div>

  <section class="card" style="margin-top:1rem">
    <h2 style="margin-top:0">ã“ã®ãƒ‡ãƒ¢ã®ä¸­èº«ï¼ˆã‚¹ã‚­ãƒ¼ãƒãƒ»åˆæœŸãƒ‡ãƒ¼ã‚¿ï¼‰</h2>
    <pre id="schemaView" style="white-space:pre-wrap"></pre>
  </section>

  <footer>
    <p>å®Ÿè£…ï¼š<code>sql.js 1.10.2</code>ï¼ˆWASMï¼‰ã€‚<br>ã“ã®ãƒšãƒ¼ã‚¸ã¯ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã—ã¦ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§é–‹ã‘ã¾ã™ï¼ˆã‚µãƒ¼ãƒä¸è¦ï¼‰ã€‚å­¦ç¿’ç”¨é€”ã«ã©ã†ãã€‚</p>
  </footer>

  <script>
    let db, SQL;

    const DEFAULT_QUERY = `-- ä¾‹ï¼šå­£èªã¨ä½œè€…ã‚’JOINã—ã¦ä¿³å¥ã‚’ä¸€è¦§\nSELECT h.id, h.text AS haiku, a.name AS author, k.term AS kigo, s.name AS season\nFROM haiku h\nLEFT JOIN authors a ON h.author_id = a.id\nLEFT JOIN kigo k ON h.kigo_id = k.id\nLEFT JOIN seasons s ON k.season_id = s.id\nORDER BY h.id;`;

    // DOM å–å¾—
    const el = (id) => document.getElementById(id);
    const sqlInput = el('sqlInput');
    const result = el('result');
    const status = el('status');
    const schemaView = el('schemaView');

    // sql.js åˆæœŸåŒ–ï¼ˆWASMã®å ´æ‰€ã‚’CDNã«å›ºå®šï¼‰
    initSqlJs({ locateFile: f => `https://cdn.jsdelivr.net/npm/sql.js@1.10.2/dist/${f}` })
      .then((SQLLib) => {
        SQL = SQLLib;
        db = new SQL.Database();
        seed();
        status.textContent = 'DB åˆæœŸåŒ–å®Œäº†ã€‚ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿æŠ•å…¥æ¸ˆã¿ã€‚';
        sqlInput.value = DEFAULT_QUERY;
        runQuery();
      })
      .catch((e) => {
        console.error(e);
        status.textContent = 'sql.js ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ ' + (e && e.message ? e.message : '');
      });

    // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿æŠ•å…¥ï¼ˆä¿³å¥ç”¨ï¼‰
    function seed() {
      const schema = `\nPRAGMA foreign_keys = ON;\n\n-- å­£ç¯€ãƒã‚¹ã‚¿\nCREATE TABLE seasons (\n  id INTEGER PRIMARY KEY,\n  name TEXT NOT NULL UNIQUE -- æ˜¥/å¤/ç§‹/å†¬/æ–°å¹´ ãªã©\n);\n\n-- å­£èªãƒã‚¹ã‚¿\nCREATE TABLE kigo (\n  id INTEGER PRIMARY KEY,\n  term TEXT NOT NULL UNIQUE,\n  reading TEXT,               -- ã‚ˆã¿ãŒãª\n  category TEXT,              -- å¤©æ–‡/åœ°ç†/äººäº‹/å‹•ç‰©/æ¤ç‰© ãªã©\n  season_id INTEGER NOT NULL,\n  FOREIGN KEY (season_id) REFERENCES seasons(id)\n);\n\n-- ä½œè€…\nCREATE TABLE authors (\n  id INTEGER PRIMARY KEY,\n  name TEXT NOT NULL UNIQUE,\n  birth_year INTEGER,\n  death_year INTEGER\n);\n\n-- ä¿³å¥\nCREATE TABLE haiku (\n  id INTEGER PRIMARY KEY,\n  text TEXT NOT NULL,\n  author_id INTEGER,\n  kigo_id INTEGER,\n  year INTEGER,              -- ä½œå¹´ï¼ˆä¸è©³ãªã‚‰NULLï¼‰\n  place TEXT,                -- åœ°ç‚¹ãƒ¡ãƒ¢\n  note TEXT,                 -- å‚™è€ƒ\n  FOREIGN KEY (author_id) REFERENCES authors(id),\n  FOREIGN KEY (kigo_id) REFERENCES kigo(id)\n);\n`;

      const data = `\n-- å­£ç¯€\nINSERT INTO seasons(id, name) VALUES\n  (1, 'æ˜¥'), (2, 'å¤'), (3, 'ç§‹'), (4, 'å†¬'), (5, 'æ–°å¹´');\n\n-- å­£èªï¼ˆã”ãä¸€éƒ¨ã®ä¾‹ï¼‰\nINSERT INTO kigo(id, term, reading, category, season_id) VALUES\n  (101, 'è›™', 'ã‹ã‚ãš', 'å‹•ç‰©', 1),\n  (102, 'å¤è‰', 'ãªã¤ãã•', 'æ¤ç‰©', 2),\n  (103, 'è‰', 'ã›ã¿', 'å‹•ç‰©', 2),\n  (104, 'æ™‚é›¨', 'ã—ãã‚Œ', 'å¤©æ–‡', 4),\n  (105, 'å†¬éš£', 'ãµã‚†ã¨ãªã‚Š', 'æ™‚å€™', 3);\n\n-- ä½œè€…\nINSERT INTO authors(id, name, birth_year, death_year) VALUES\n  (201, 'æ¾å°¾èŠ­è•‰', 1644, 1694),\n  (202, 'ä¸è¬è•ªæ‘', 1716, 1784),\n  (203, 'å°æ—ä¸€èŒ¶', 1763, 1828),\n  (204, 'æ­£å²¡å­è¦', 1867, 1902),\n  (205, 'ç¾ä»£ä½œè€…', NULL, NULL);\n\n-- ä¿³å¥ï¼ˆå­¦ç¿’ç”¨ã®å°‘æ•°ä¾‹ã€å‡ºå…¸ç•¥ï¼‰\nINSERT INTO haiku(id, text, author_id, kigo_id, year, place, note) VALUES\n  (1,  'å¤æ± ã‚„ è›™é£›ã³ã“ã‚€ æ°´ã®éŸ³',         201, 101, 1686, 'æ±Ÿæˆ¸',        'æ˜¥ï¼šè›™'),\n  (2,  'å¤è‰ã‚„ å…µã©ã‚‚ãŒ å¤¢ã®è·¡',             201, 102, 1689, 'å¹³æ³‰',        'å¤ï¼šå¤è‰'),\n  (3,  'é–‘ã•ã‚„ å²©ã«ã—ã¿å…¥ã‚‹ è‰ã®å£°',         201, 103, 1689, 'å±±å½¢ãƒ»ç«‹çŸ³å¯º','å¤ï¼šè‰'),\n  (4,  'åˆã—ãã‚Œ çŒ¿ã‚‚å°è“‘ã‚’ ã»ã—ã’ãªã‚Š',     201, 104, NULL, 'å¤§æ´¥',        'å†¬ï¼šæ™‚é›¨'),\n  (5,  'å†¬éš£ å°å±‹ã®é“å…·ã‚‚ ç•°å‹•æ™‚æœŸ',         205, 105, 2024, 'æ´¥è»½',        'å­¦ç¿’ç”¨ãƒ€ãƒŸãƒ¼ï¼ˆå†¬éš£ï¼‰'),\n  (6,  'ç›®ã«ã¯é’è‘‰ å±±ã»ã¨ã¨ãã™ åˆé°¹',       202, 101, NULL, 'æ±Ÿæˆ¸',        'â€»å­£èªãŒè¤‡æ•°å…¥ã‚‹ä¾‹ï¼šå®Ÿéš›ã¯é‡è¤‡ç®¡ç†ãŒå¿…è¦'),\n  (7,  'ã‚„ã›è›™ ã¾ã‘ã‚‹ãªä¸€èŒ¶ ã“ã‚Œã«ã‚ã‚Š',     203, 101, NULL, 'ä¿¡å·',        'è›™ï¼ˆåŠ±ã¾ã—ï¼‰'),\n  (8,  'æŸ¿ãã¸ã° é˜ãŒé³´ã‚‹ãªã‚Š æ³•éš†å¯º',       204, NULL, 1895, 'å¥ˆè‰¯',        'å­£èªï¼šæŸ¿ï¼ˆæœ¬ãƒ‡ãƒ¢ã§ã¯æœªç™»éŒ²ï¼‰');\n`;

      db.run('DROP TABLE IF EXISTS haiku;');
      db.run('DROP TABLE IF EXISTS authors;');
      db.run('DROP TABLE IF EXISTS kigo;');
      db.run('DROP TABLE IF EXISTS seasons;');
      db.run(schema);
      db.run(data);

      schemaView.textContent = schema + '\n' + data;
    }

    // ã‚¯ã‚¨ãƒªå®Ÿè¡Œ
    function runQuery() {
      clearResults();
      const sql = sqlInput.value.trim();
      if (!sql) return;
      const start = performance.now();
      try {
        const results = db.exec(sql); // è¤‡æ•°ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆå¯¾å¿œ
        if (!results.length) {
          appendInfo('å®Ÿè¡Œå®Œäº†ï¼ˆè¿”ã™çµæœã‚»ãƒƒãƒˆãªã—ï¼‰ã€‚');
        } else {
          results.forEach(drawTable);
        }
        const ms = Math.round((performance.now() - start) * 100) / 100;
        appendInfo(`å®Œäº†ï¼š${ms} ms`);
      } catch (e) {
        appendError(e.message || String(e));
      }
    }

    // è¡¨æç”»
    function drawTable(res) {
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const trh = document.createElement('tr');
      res.columns.forEach(col => {
        const th = document.createElement('th');
        th.textContent = col;
        trh.appendChild(th);
      });
      thead.appendChild(trh);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      res.values.forEach(row => {
        const tr = document.createElement('tr');
        row.forEach((cell) => {
          const td = document.createElement('td');
          td.textContent = cell;
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);

      result.appendChild(table);
    }

    function appendInfo(msg) {
      const p = document.createElement('p');
      p.className = 'muted';
      p.textContent = msg;
      result.appendChild(p);
    }

    function appendError(msg) {
      const p = document.createElement('p');
      p.style.color = 'crimson';
      p.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + msg;
      result.appendChild(p);
    }

    function clearResults() { result.innerHTML = ''; }

    // ã‚¤ãƒ™ãƒ³ãƒˆ
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') { runQuery(); }
    });
    document.getElementById('runBtn').addEventListener('click', runQuery);
    document.getElementById('resetBtn').addEventListener('click', () => { seed(); runQuery(); });
    document.querySelectorAll('button[data-snippet]').forEach(btn => {
      btn.addEventListener('click', () => {
        sqlInput.value = btn.getAttribute('data-snippet');
        runQuery();
      });
    });

    // ã‹ã‚“ãŸã‚“æ¤œç´¢ãƒ­ã‚¸ãƒƒã‚¯
    function runSQL(sql){ sqlInput.value = sql; runQuery(); }
    function buildSearchSQL(q, type){
      const esc = q.replace(/'/g, "''");
      if(type === 'author'){
        return `SELECT h.id, h.text AS haiku, a.name AS author\nFROM haiku h LEFT JOIN authors a ON h.author_id=a.id\nWHERE a.name LIKE '%${esc}%';`;
      } else if(type === 'kigo'){
        return `SELECT h.id, h.text AS haiku, a.name AS author, k.term AS kigo\nFROM haiku h LEFT JOIN authors a ON h.author_id=a.id\nLEFT JOIN kigo k ON h.kigo_id=k.id\nWHERE k.term LIKE '%${esc}%';`;
      } else if(type === 'season'){
        return `SELECT h.id, h.text AS haiku, a.name AS author, s.name AS season\nFROM haiku h LEFT JOIN authors a ON h.author_id=a.id\nLEFT JOIN kigo k ON h.kigo_id=k.id\nLEFT JOIN seasons s ON k.season_id=s.id\nWHERE s.name LIKE '%${esc}%';`;
      } else { // text
        return `SELECT h.id, h.text AS haiku, a.name AS author\nFROM haiku h LEFT JOIN authors a ON h.author_id=a.id\nWHERE h.text LIKE '%${esc}%';`;
      }
    }
    const qInput = document.getElementById('qInput');
    const qType  = document.getElementById('qType');
    document.getElementById('qRun').addEventListener('click', () => {
      const q = (qInput.value || '').trim(); if(!q) return; runSQL(buildSearchSQL(q, qType.value));
    });
    document.querySelectorAll('.chip').forEach(b => {
      b.addEventListener('click', () => {
        const q = b.getAttribute('data-q');
        const t = b.getAttribute('data-type');
        qInput.value = q; qType.value = t; runSQL(buildSearchSQL(q, t));
      });
    });
  </script>
</body>
</html>
